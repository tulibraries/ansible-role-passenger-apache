---

- name: Make sure passenger prerequisites are installed
  dnf:
    name: ["epel-release"]
    state: installed
  become: true
  tags:
    - passenger

- name: Download Phusion Passenger GPG Key
  ansible.builtin.get_url:
    url: "https://oss-binaries.phusionpassenger.com/phusion-software-signing-gpg-key.txt"
    dest: "/tmp/phusion-key.asc"
    mode: "0644"
  tags:
    - passenger

- name: Temporarily Allow Weak Digest Algorithms (SHA1) for GPG
  ansible.builtin.shell: |
    echo "allow-weak-digest-algos" >> /etc/gnupg/gpg.conf
  args:
    executable: /bin/bash
  tags:
    - passenger

- name: Import GPG key into the GPG keyring
  command: "gpg --no-default-keyring --keyring /etc/pki/rpm-gpg/passenger-gpg-keyring.gpg --import /tmp/phusion-key.asc"
  args:
    creates: "/etc/pki/rpm-gpg/passenger-gpg-keyring.gpg"
  become: true
  tags:
    - passenger

- name: Export GPG key from keyring
  command: >
    gpg --no-default-keyring --keyring /etc/pki/rpm-gpg/passenger-gpg-keyring.gpg
    --armor --export -o /etc/pki/rpm-gpg/passenger.asc
  args:
    creates: /etc/pki/rpm-gpg/passenger.asc
  become: true
  tags:
    - passenger


#- name: Add the GPG key to RPM
  #rpm_key:
    #key: "/etc/pki/rpm-gpg/passenger-gpg-keyring.gpg"
    #state: present
  #become: true
  #tags:
    #- passenger

- name: Import GPG key manually
  command: rpm --import /etc/pki/rpm-gpg/passenger.asc 
  become: true
  tags:
    - passenger

- name: Re-sign the GPG Key with Stronger Hash Algorithms (SHA256, SHA512)
  ansible.builtin.shell: |
    gpg --batch --yes --edit-key $(gpg --list-keys --with-colons | awk -F: '/^pub/ {print $5; exit}') trust
    echo -e "trust\n5\ny\nsetpref SHA512 SHA384 SHA256 AES256 AES192 AES CAST5 ZLIB BZIP2 ZIP Uncompressed\nupdpref\nsave" | gpg --batch --edit-key $(gpg --list-keys --with-colons | awk -F: '/^pub/ {print $5; exit}')
  args:
    executable: /bin/bash
  tags:
    - passenger

- name: Export the Re-signed GPG Key
  ansible.builtin.shell: |
    gpg --export --armor $(gpg --list-keys --with-colons | awk -F: '/^pub/ {print $5; exit}') > /tmp/phusion-key-updated.asc
  args:
    executable: /bin/bash
  tags:
    - passenger

- name: Import the Re-signed GPG Key into the System Keyring
  ansible.builtin.shell: |
    rpm --import /tmp/phusion-key-updated.asc
  args:
    executable: /bin/bash
  tags:
    - passenger

- name: Remove Weak Digest Allowance (for security)
  ansible.builtin.shell: |
    sed -i '/allow-weak-digest-algos SHA1/d' /etc/gnupg/gpg.conf
  args:
    executable: /bin/bash
  tags:
    - passenger

- name: add passenger repository config
  template:
    src: "{{ passenger_yum_repo_template }}"
    dest: "{{ passenger_yum_repos_path }}"
  become: true
  tags:
    - passenger

- name: Install the passenger repository
  yum:
    name: "{{ passenger_package_name }}"
    state: installed
    update_cache: true
  become: true
  notify: restart apache
  tags:
    - passenger
